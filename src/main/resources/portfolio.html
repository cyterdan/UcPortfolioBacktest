  <link rel="stylesheet" href="../slickgrid/slick.grid.css" type="text/css"/>
  <link rel="stylesheet" href="../slickgrid/css/smoothness/jquery-ui-1.11.3.custom.css" type="text/css"/>
  <link rel="stylesheet" href="../slickgrid/css/select2.css" type="text/css"/>
    <link rel="stylesheet" href="../slickgrid/examples/examples.css" type="text/css"/>

   <style>
	.select2-container {
		top: -3px;
		left: -6px;
	}
    .select2-container .select2-selection--single {
		height: 26px;
	}  
</style>

<p>
    configurer un portefeuille :
</p>
<div style="position:relative">
  <div style="width:50%;">
    <div id="myGrid" style="width:100%;height:200px;"></div>
  </div>
    <div id="goButton" >Go !</div>
  
    <div id="history" style="min-width: 310px; height: 400px; margin: 0 auto"></div>


<script src="../slickgrid/lib/firebugx.js"></script>

<script src="../slickgrid/lib/jquery-1.11.2.min.js"></script>
<script src="../slickgrid/lib/jquery-ui-1.11.3.min.js"></script>
<script src="../slickgrid/lib/jquery.event.drag-2.3.0.js"></script>

<script src="../slickgrid/slick.core.js"></script>
<script src="../slickgrid/plugins/slick.cellrangedecorator.js"></script>
<script src="../slickgrid/plugins/slick.cellrangeselector.js"></script>
<script src="../slickgrid/plugins/slick.cellselectionmodel.js"></script>
<script src="../slickgrid/slick.formatters.js"></script>
<script src="../slickgrid/slick.editors.js"></script>
<script src="../slickgrid/slick.grid.js"></script>
<script src="../slickgrid/lib/select2.js"></script>
<script src="../fonds.js"></script>
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>

<script src="../plugins/jquery.blockUI.js"></script>



<script>


   function PopulateSelect(select, dataSource, addBlank) {
        var index, len, newOption;
        if (addBlank) { select.appendChild(new Option('', '')); }
        $.each(dataSource, function (value, text) {
             newOption = new Option(text, value);
            select.appendChild(newOption);
       });
    };
    
   function percentValidator(value) {
    if (value > 100 || value < 0) {
      return {valid: false, msg: "0%->100%"};
    } else {
      return {valid: true, msg: null};
    }
  }


    function Select2Editor(args) {
        var $input;
        var defaultValue;
        var scope = this;
        var calendarOpen = false;

        this.keyCaptureList = [ Slick.keyCode.UP, Slick.keyCode.DOWN, Slick.keyCode.ENTER ];

        this.init = function () {
            $input = $('<select></select>');
            $input.width(args.container.clientWidth + 3);
            PopulateSelect($input[0], args.column.dataSource, true);

            $input.appendTo(args.container);
            $input.focus().select();
			
            $input.select2({
                placeholder: '-',
				allowClear: true
            });
        };

        this.destroy = function () {
            $input.select2('destroy');
            $input.remove();
        };

        this.show = function () {
        };

        this.hide = function () {
            $input.select2('results_hide');
        };

        this.position = function (position) {
        };

        this.focus = function () {
            $input.select2('input_focus');
        };

        this.loadValue = function (item) {
            defaultValue = item[args.column.field];
            $input.val(defaultValue);
            $input[0].defaultValue = defaultValue;
            $input.trigger("change.select2");
        };

        this.serializeValue = function () {
            return $input.val();
        };

        this.applyValue = function (item, state) {
            item[args.column.field] = state;
        };

        this.isValueChanged = function () {
            return (!($input.val() == "" && defaultValue == null)) && ($input.val() != defaultValue);
        };

        this.validate = function () {
            return {
                valid: true,
                msg: null
            };
        };

        this.init();
    }
	
    function Select2Formatter(row, cell, value, columnDef, dataContext) {
        return columnDef.dataSource[value] || '-';
    }	
    
     function percentFormatter(row, cell, value, columnDef, dataContext) {
        if (value == null || value == undefined) {
              return "-"
            } else {
              return value+"%"
            }
      }	
</script>
<script>
  // stackoverflow.com/questions/2532218
  function pickRandomProperty(obj) {
	var result;
	var count = 0;
	for (var prop in obj)
		if (Math.random() < 1/++count)
		   result = prop;
	return result;
  }
	
  function requiredFieldValidator(value) {
    if (value == null || value == undefined || !value.length) {
      return {valid: false, msg: "This is a required field"};
    } else {
      return {valid: true, msg: null};
    }
  }

  var grid;
  var data = [];
  var columns = [
    {id: "uc", name: "uc", field: "uc", width: 400, cssClass: "cell-title", formatter: Select2Formatter, 
		editor: Select2Editor, dataSource: funds},
    {id: "part", name: "%", field: "part", minWidth: 100, editor: Slick.Editors.Integer ,formatter: percentFormatter,validator : percentValidator}  ];
  var options = {
    editable: true,
    enableAddRow: true,
    enableCellNavigation: true,
    asyncEditorLoading: false,
    autoEdit: false
  };

  $(function () {
    for (var i = 0; i < 5; i++) {
      var d = (data[i] = {});


    }

    grid = new Slick.Grid("#myGrid", data, columns, options);

    grid.setSelectionModel(new Slick.CellSelectionModel());

    grid.onAddNewRow.subscribe(function (e, args) {
      var item = args.item;
      grid.invalidateRow(data.length);
      data.push(item);
      grid.updateRowCount();
      grid.render();
    });
    
    
    function doGraph(history,reference){
        Highcharts.chart('history', {
        chart: {
            zoomType: 'x'
        },
        title: {
            text: 'Historique de ce portefeuille'
        },
        subtitle: {
            text: document.ontouchstart === undefined ?
                    'Click and drag in the plot area to zoom in' : 'Pinch the chart to zoom in'
        },
        xAxis: {
             type: 'datetime'
             
          
        },
        yAxis: {
            title: {
                text: 'Performance (sans unité)'
            }
        },
        legend: {
            enabled: true
        },
        plotOptions: {
            area: {
                fillColor: {
                    linearGradient: {
                        x1: 0,
                        y1: 0,
                        x2: 0,
                        y2: 1
                    },
                    stops: [
                        [0, Highcharts.getOptions().colors[0]],
                        [1, Highcharts.Color(Highcharts.getOptions().colors[0]).setOpacity(0).get('rgba')]
                    ]
                },
                marker: {
                    radius: 2
                },
                lineWidth: 1,
                states: {
                    hover: {
                        lineWidth: 1
                    }
                },
                threshold: null
            }
        },

        series: [{
            type: 'area',
            name: 'Backtest',
            data: history
        },
        {
            type : 'line',
            name : 'reference',
            data : reference
        }]
    });
    }
    
    
    $('#goButton').button(
                ).unbind('click').click(function() {
        var send=[];
        var data = grid.getData();
        for(var i=0;i<data.length;i++){
                   send.push({'uc':data[i]['uc'],'part':data[i]['part']});
               }
               
               console.log(send);
    
            
        $.blockUI({ 
            css: { 
            border: 'none', 
            padding: '5px',
            
            backgroundColor: '#000', 
            '-webkit-border-radius': '10px', 
            '-moz-border-radius': '10px', 
            opacity: .5, 
            color: '#fff' 
        },
            message : "backtest en cours.."
        
        });
        $.ajax({
            url: "/backtest",
            method:"post",
            data  :  {data:send,size:send.length},
            context: document.body,
            
            success: function (data, textStatus, jqXHR) {
                        
                        if(data.status === "ERROR") {
                            alert(data.message);
                        }
                        
                        
                        if(data.status === "OK"){
                            h = []
                            for(var i=0;i<data.history.length;i++){
                                e = []
                                e[0] = Date.UTC(data.history[i][0],data.history[i][1],data.history[i][2]);
                                e[1] = data.history[i][3];
                                h[i] = e;
                            }
                            r = []
                            for(var j=0;j<data.reference.length;j++){
                                e = []
                                e[0] = Date.UTC(data.reference[j][0],data.reference[j][1],data.reference[j][2]);
                                e[1] = data.reference[j][3];
                                r[j] = e;
                            }
                            
                            doGraph(h,r);
                            $('#performance').val(data.perf);
                            $('#volatilite').val(data.std);
                        }
                        
                                
                    },
                 error : function(){
                                   $.unblockUI();

                     alert("Oops ! quelque chose est cassé");
                 }
                 
          }).done(function() {
              $.unblockUI();
          });

  
});
  });
</script>
 


@{oki}
